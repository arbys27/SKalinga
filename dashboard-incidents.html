<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKalinga - Incidents</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Your shared dashboard CSS -->
    <link rel="stylesheet" href="assets/css/dashboard.css">

    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Session Checker Helper -->
    <script src="js/session-checker.js"></script>

    <style>
        /* User Profile Card - Themed Design */
        .user-profile-card {
            position: relative;
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 18px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.88) 100%);
            border-radius: 14px;
            border: 2px solid rgba(93, 173, 226, 0.3);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(93, 173, 226, 0.15);
            backdrop-filter: blur(10px);
        }

        .user-profile-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 107, 157, 0.1), rgba(93, 173, 226, 0.1));
            border-radius: 14px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .user-profile-card:hover::before {
            opacity: 1;
        }

        .user-profile-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(93, 173, 226, 0.25);
            border-color: rgba(93, 173, 226, 0.6);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.92) 100%);
        }

        .user-avatar-new {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #FF6B9D 0%, #5DADE2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 16px;
            flex-shrink: 0;
            position: relative;
            box-shadow: 0 4px 16px rgba(93, 173, 226, 0.3);
            transition: all 0.3s ease;
        }

        .user-profile-card:hover .user-avatar-new {
            transform: scale(1.08);
            box-shadow: 0 6px 20px rgba(93, 173, 226, 0.4);
        }

        .user-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        #userFullName {
            font-size: 15px;
            font-weight: 700;
            color: #222;
            margin: 0;
            font-family: 'IBM Plex Sans', sans-serif;
        }

        .user-role-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #228B57 0%, #1a6b43 100%);
            color: #A8E6CF;
            font-size: 10px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            width: fit-content;
            box-shadow: 0 2px 8px rgba(34, 139, 87, 0.2);
            transition: all 0.3s ease;
        }

        .user-profile-card:hover .user-role-badge {
            box-shadow: 0 4px 12px rgba(34, 139, 87, 0.3);
            transform: translateY(-1px);
        }

        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: white;
            padding: 14px 18px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            font-weight: 500;
            border-left: 4px solid;
        }

        .toast.success {
            border-left-color: #27AE60;
        }

        .toast.success .toast-icon {
            color: #27AE60;
        }

        .toast.error {
            border-left-color: #E74C3C;
        }

        .toast.error .toast-icon {
            color: #E74C3C;
        }

        .toast.warning {
            border-left-color: #F39C12;
        }

        .toast.warning .toast-icon {
            color: #F39C12;
        }

        .toast.info {
            border-left-color: #5DADE2;
        }

        .toast.info .toast-icon {
            color: #5DADE2;
        }

        .toast-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .toast-message {
            flex: 1;
            color: #333;
        }

        .toast.removing {
            animation: slideOutRight 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.in_review {
            background: #cfe2ff;
            color: #084298;
        }

        .status-badge.under_action {
            background: #cff4fc;
            color: #055160;
        }

        .status-badge.resolved {
            background: #d1e7dd;
            color: #0f5132;
        }

        .status-badge.closed {
            background: #e2e3e5;
            color: #383d41;
        }

        .urgency-high {
            color: #E74C3C;
            font-weight: 700;
        }

        .urgency-emergency {
            color: #C0392B;
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .user-profile-card {
                padding: 12px 16px;
                gap: 12px;
            }

            .user-avatar-new {
                width: 44px;
                height: 44px;
                font-size: 14px;
            }

            #userFullName {
                font-size: 14px;
            }

            .user-role-badge {
                font-size: 9px;
                padding: 3px 9px;
            }

            #toastContainer {
                top: 10px;
                right: 10px;
                left: 10px;
            }

            .toast {
                max-width: 100%;
            }
        }
    </style>
    
</head>
<body>

<div class="app-container">

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo-section">
            <div class="logo-content">
                <div class="logo-icons-group">
                    <img src="assets/images/logosanantonio.jpg" alt="San Antonio Logo" class="official-logo">
                    <img src="assets/images/sklogo.jpg" alt="SK Logo" class="official-logo">
                </div>
                <div class="logo-text">
                    <h1>SKalinga Admin</h1>
                    <p>San Antonio</p>
                </div>
            </div>
        </div>

        <nav class="nav-section">
            <div class="nav-group">
                <div class="nav-group-title">Overview</div>
                <a href="admin-dashboard.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Dashboard
                </a>
                <a href="admin-dashboard.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                    Analytics
                </a>
            </div>

            <div class="nav-group">
                <div class="nav-group-title">Management</div>
                <a href="youth-registry.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Youth Registry
                </a>
                <a href="dashboard-events.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    Events
                </a>
                <a href="dashboard-resources.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    </svg>
                    Resources
                </a>
                <a href="dashboard-printing.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 6 2 18 2 18 9"></polyline>
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                        <rect x="6" y="14" width="12" height="8"></rect>
                    </svg>
                    Printing
                </a>
            </div>

            <div class="nav-group">
                <div class="nav-group-title">Emergency</div>
                <a href="dashboard-incidents.html" class="nav-item active">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    Incidents
                </a>

                <a href="dashboard-health.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                    </svg>
                    Health Services
                </a>
            </div>

            <div class="nav-group">
                <div class="nav-group-title">Public</div>
                <a href="dashboard-public_disclosure.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Public Disclosure
                </a>
            </div>

            <div class="nav-group">
                <div class="nav-group-title">System</div>
                <a href="dashboard-settings.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    Settings
                </a>
                <a href="api/logout.php" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    Logout
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="top-header">
            <div class="header-left">
                <h2>Incidents</h2>
                <p id="dashboard-datetime">Loading date and time...</p>
            </div>
            <div class="header-right">
                <div class="user-profile-card">
                    <div class="user-avatar-new" id="userAvatarInitials">--</div>
                    <div class="user-details">
                        <h4 id="userFullName">Loading...</h4>
                        <span class="user-role-badge" id="userRole">Administrator</span>
                    </div>
                </div>
            </div>
        </header>

        <div class="dashboard-content">
            <div class="search-filter-bar">
                <div class="search-group">
                    <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” Search by member name, ID, location...">
                </div>
                <select id="filterStatus" class="filter-select">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="in_review">In Review</option>
                    <option value="under_action">Under Action</option>
                    <option value="resolved">Resolved</option>
                    <option value="closed">Closed</option>
                </select>
                <select id="filterUrgency" class="filter-select">
                    <option value="">All Urgency</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                    <option value="emergency">Emergency</option>
                </select>
            </div>

            <table class="admin-table" id="incidentsTable">
                <thead>
                    <tr>
                        <th>Incident ID</th>
                        <th>Member Name</th>
                        <th>Category</th>
                        <th>Location</th>
                        <th>Urgency</th>
                        <th>Status</th>
                        <th>Submitted</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="incidentsTableBody"></tbody>
            </table>
        </div>

</main>

</div>

<!-- Toast Notification Container -->
<div id="toastContainer"></div>

<!-- Confirmation Modal -->
<div class="modal" id="confirmationModal">
    <div class="modal-content" style="max-width: 420px;">
        <h2 style="margin-bottom: 12px; color: #E74C3C;">
            <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i> Confirm Action
        </h2>
        <p id="confirmMessage" style="color: #666; margin: 0 0 28px 0; font-size: 15px; line-height: 1.5;"></p>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button id="confirmCancelBtn" class="action-btn" style="background: #95A5A6; margin: 0; padding: 10px 24px;">Cancel</button>
            <button id="confirmOkBtn" class="action-btn" style="background: linear-gradient(135deg, #E74C3C 0%, #C0392B 100%); margin: 0; padding: 10px 24px; color: white;"><i class="fas fa-trash" style="margin-right: 6px;"></i> Delete</button>
        </div>
    </div>
</div>

<!-- Incident Details Modal -->
<div class="modal" id="incidentDetailModal">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close-modal" id="closeDetailModal">Ã—</span>
        <h2>Incident Details</h2>
        <div id="incidentDetailsContent" style="line-height: 1.8; margin-bottom: 24px;"></div>
        
        <div style="margin-bottom: 24px;">
            <h3>Update Status & Add Notes</h3>
            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                <select id="statusSelect" style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <option value="pending">Pending</option>
                    <option value="in_review">In Review</option>
                    <option value="under_action">Under Action</option>
                    <option value="resolved">Resolved</option>
                    <option value="closed">Closed</option>
                </select>
            </div>
            <textarea id="adminNotesInput" placeholder="Add admin notes..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical; min-height: 80px;"></textarea>
            <button id="saveStatusBtn" class="btn-submit" style="margin-top: 12px; width: 100%;">Save Status & Notes</button>
        </div>
    </div>
</div>

<!-- Photo Lightbox Modal -->
<div class="modal" id="photoLightbox" style="background: rgba(0,0,0,0.95); z-index: 10000;">
    <div style="position: relative; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">
        <span class="close-modal" id="closeLightbox" style="position: absolute; top: 20px; right: 30px; font-size: 40px; color: white; cursor: pointer;">Ã—</span>
        <img id="lightboxImage" src="" style="max-width: 90vw; max-height: 90vh; object-fit: contain; border-radius: 8px;">
    </div>
</div>

<script>
// Check authentication on page load
document.addEventListener('DOMContentLoaded', async function() {
    const user = await checkAuthSession();
    if (!user) {
        // User is not logged in, redirected automatically
        return;
    }
    // Page is authenticated, continue loading
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Toast Notification
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showAlert(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    
    let icon = 'âœ“';
    if (type === 'error') {
        icon = 'âŒ';
    } else if (type === 'warning') {
        icon = 'âš ï¸';
    } else if (type === 'info') {
        icon = 'â„¹ï¸';
    }
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <span class="toast-icon">${icon}</span>
        <span class="toast-message">${message}</span>
    `;
    
    container.appendChild(toast);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        toast.classList.add('removing');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 4000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Confirmation Modal
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showConfirm(message, onConfirm) {
    const confirmModal = document.getElementById('confirmationModal');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmOkBtn = document.getElementById('confirmOkBtn');
    const confirmCancelBtn = document.getElementById('confirmCancelBtn');
    
    confirmMessage.textContent = message;
    confirmModal.style.display = 'flex';
    
    confirmOkBtn.onclick = () => {
        confirmModal.style.display = 'none';
        if (onConfirm) onConfirm();
    };
    
    confirmCancelBtn.onclick = () => {
        confirmModal.style.display = 'none';
    };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Load User Profile
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUserProfile() {
    try {
        const response = await fetch('api/get_user_profile.php');
        const result = await response.json();
        
        if (result.success) {
            const user = result.user;
            document.getElementById('userAvatarInitials').textContent = user.initials;
            document.getElementById('userFullName').textContent = user.name;
            document.getElementById('userRole').textContent = user.role;
        } else {
            console.error('Error loading user profile:', result.error);
            document.getElementById('userFullName').textContent = 'Guest User';
        }
    } catch (error) {
        console.error('Error fetching user profile:', error);
        document.getElementById('userFullName').textContent = 'Guest User';
    }
}

window.addEventListener('load', () => {
    loadUserProfile();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Date & Time
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDashboardDateTime() {
    const el = document.getElementById('dashboard-datetime');
    if (!el) return;
    const now = new Date();
    el.textContent = now.toLocaleString('en-US', {
        weekday: 'long', month: 'long', day: 'numeric', year: 'numeric',
        hour: 'numeric', minute: '2-digit', hour12: true
    });
}
setInterval(updateDashboardDateTime, 1000);
updateDashboardDateTime();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Data Management - Load Incidents from Database
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let incidentsData = [];

async function loadIncidents() {
    try {
        const response = await fetch('api/get_incidents.php');
        const result = await response.json();
        
        if (result.success) {
            incidentsData = result.data || [];
            renderIncidentsTable();
            filterIncidents();
        } else {
            showAlert('Error loading incidents: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error('Error loading incidents:', error);
        showAlert('Failed to load incidents', 'error');
    }
}

// Render incidents table
function renderIncidentsTable(filtered = incidentsData) {
    const tbody = document.getElementById('incidentsTableBody');
    tbody.innerHTML = '';

    filtered.forEach(incident => {
        const fullName = `${incident.firstname} ${incident.lastname}`;
        const submittedDate = new Date(incident.submitted_date).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="font-family: 'JetBrains Mono', monospace; font-weight: 600;">#${incident.id}</td>
            <td style="font-weight: 600;">${fullName}</td>
            <td><strong style="text-transform: capitalize;">${incident.category.replace('_', ' ')}</strong></td>
            <td>${incident.location}</td>
            <td>
                <strong class="urgency-${incident.urgency === 'emergency' || incident.urgency === 'high' ? incident.urgency : ''}">
                    ${incident.urgency.charAt(0).toUpperCase() + incident.urgency.slice(1)}
                </strong>
            </td>
            <td><span class="status-badge ${incident.status}">${incident.status.replace('_', ' ')}</span></td>
            <td>${submittedDate}</td>
            <td class="action-buttons">
                <button class="action-btn btn-view" onclick="viewIncidentDetail('${incident.id}')" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn btn-delete" onclick="deleteIncident('${incident.id}')" title="Delete Incident">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Search & Filter
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterIncidents() {
    const search = document.getElementById('searchInput').value.toLowerCase().trim();
    const status = document.getElementById('filterStatus').value;
    const urgency = document.getElementById('filterUrgency').value;

    const filtered = incidentsData.filter(i => {
        const text = `${i.id} ${i.firstname} ${i.lastname} ${i.member_id} ${i.location} ${i.category}`.toLowerCase();
        return text.includes(search) && 
               (!status || i.status === status) &&
               (!urgency || i.urgency === urgency);
    });

    renderIncidentsTable(filtered);
}

document.getElementById('searchInput')?.addEventListener('input', filterIncidents);
document.getElementById('filterStatus')?.addEventListener('change', filterIncidents);
document.getElementById('filterUrgency')?.addEventListener('change', filterIncidents);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Modal Controls
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const detailModal = document.getElementById('incidentDetailModal');
document.getElementById('closeDetailModal').onclick = () => detailModal.style.display = 'none';

window.onclick = e => {
    if (e.target.classList.contains('modal')) e.target.style.display = 'none';
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// View Incident Details
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function viewIncidentDetail(incidentId) {
    const incident = incidentsData.find(i => i.id == incidentId);
    if (!incident) {
        showAlert('Incident not found', 'error');
        return;
    }

    const submittedDate = new Date(incident.submitted_date).toLocaleString('en-US', {
        month: 'long', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit'
    });

    // Get member name with fallback
    const memberName = (incident.firstname && incident.firstname !== 'Unknown') 
        ? `${incident.firstname} ${incident.lastname}` 
        : `Unknown Member (${incident.member_id})`;

    let html = `
        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #FF6B9D 0%, #5DADE2 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 14px; flex-shrink: 0;">
                    ${incident.firstname ? incident.firstname.charAt(0).toUpperCase() : '?'}
                </div>
                <div>
                    <p style="margin: 0; font-weight: 700; font-size: 15px; color: #222;">${memberName}</p>
                    <p style="margin: 4px 0 0 0; font-size: 13px; color: #666;">ID: ${incident.member_id}</p>
                </div>
            </div>
        </div>

        <p><strong>Incident ID:</strong> #${incident.id}</p>
        <p><strong>Contact:</strong> ${incident.phone}</p>
        <p><strong>Address:</strong> ${incident.address}</p>
        <p><strong>Category:</strong> <span style="background: #e3f2fd; padding: 2px 8px; border-radius: 4px; font-weight: 600;">${incident.category.toUpperCase()}</span></p>
        <p><strong>Location:</strong> ${incident.location}</p>
        <p><strong>Urgency:</strong> <span class="urgency-${incident.urgency === 'emergency' || incident.urgency === 'high' ? incident.urgency : ''}" style="padding: 2px 8px; border-radius: 4px; background: ${incident.urgency === 'emergency' ? '#ffebee' : incident.urgency === 'high' ? '#fff3e0' : '#f1f8e9'}; display: inline-block; font-weight: 600;">${incident.urgency.toUpperCase()}</span></p>
        <p><strong>Status:</strong> <span class="status-badge ${incident.status}">${incident.status.replace('_', ' ')}</span></p>
        <p><strong>Submitted:</strong> ${submittedDate}</p>
        <hr style="margin: 12px 0; border: none; border-top: 1px solid #eee;">
        <p><strong>Description:</strong></p>
        <p style="background: #f9f9f9; padding: 12px; border-radius: 6px; white-space: pre-wrap; line-height: 1.6;">${incident.description}</p>
        ${incident.photo_path ? (() => {
            let photosHtml = '<p><strong>Photos:</strong><br>';
            try {
                // Try to parse as JSON array first
                const photoPaths = JSON.parse(incident.photo_path);
                if (Array.isArray(photoPaths)) {
                    photosHtml += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">';
                    photoPaths.forEach(path => {
                        photosHtml += `<div style="position: relative; cursor: pointer;" onclick="openPhotoLightbox('${path.replace(/'/g, "\\'")}')" title="Click to view full screen"><img src="${path}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" onerror="this.src='https://via.placeholder.com/150?text=Photo+Error'"><div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.6); color: white; padding: 5px 10px; border-radius: 4px; opacity: 0; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0'"><i class="fas fa-search-plus"></i></div></div>`;
                    });
                    photosHtml += '</div>';
                } else {
                    // Fallback: treat as single path
                    photosHtml += `<div style="margin-top: 10px;"><img src="${incident.photo_path}" onclick="openPhotoLightbox('${incident.photo_path.replace(/'/g, "\\'")}')" style="max-width: 100%; max-height: 300px; border-radius: 6px; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'" onerror="this.src='https://via.placeholder.com/300?text=Photo+Error'"><br><small style="color: #999; font-size: 12px;"><i class="fas fa-search"></i> Click to view full screen</small></div>`;
                }
            } catch (e) {
                // If not JSON, treat as single path string
                photosHtml += `<div style="margin-top: 10px;"><img src="${incident.photo_path}" onclick="openPhotoLightbox('${incident.photo_path.replace(/'/g, "\\'")}')" style="max-width: 100%; max-height: 300px; border-radius: 6px; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'" onerror="this.src='https://via.placeholder.com/300?text=Photo+Error'"><br><small style="color: #999; font-size: 12px;"><i class="fas fa-search"></i> Click to view full screen</small></div>`;
            }
            photosHtml += '</p>';
            return photosHtml;
        })() : ''}
        ${incident.admin_notes ? `<p><strong>Admin Notes:</strong><br><div style="background: #f0f4ff; padding: 10px; border-left: 4px solid #5DADE2; border-radius: 4px; margin-top: 8px;">${incident.admin_notes}</div></p>` : ''}
    `;

    document.getElementById('incidentDetailsContent').innerHTML = html;
    document.getElementById('statusSelect').value = incident.status;
    document.getElementById('adminNotesInput').value = incident.admin_notes || '';
    
    document.getElementById('saveStatusBtn').onclick = async () => {
        await updateIncidentStatus(incident.id);
    };

    detailModal.style.display = 'flex';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Photo Lightbox
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPhotoLightbox(photoPath) {
    const lightbox = document.getElementById('photoLightbox');
    const lightboxImage = document.getElementById('lightboxImage');
    lightboxImage.src = photoPath;
    lightbox.style.display = 'flex';
}

document.getElementById('closeLightbox')?.addEventListener('click', () => {
    document.getElementById('photoLightbox').style.display = 'none';
});

// Close lightbox when clicking outside image
document.getElementById('photoLightbox')?.addEventListener('click', (e) => {
    if (e.target.id === 'photoLightbox') {
        document.getElementById('photoLightbox').style.display = 'none';
    }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Update Incident Status
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function updateIncidentStatus(incidentId) {
    const status = document.getElementById('statusSelect').value;
    const adminNotes = document.getElementById('adminNotesInput').value.trim();

    try {
        const response = await fetch('api/update_incident_status.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                incident_id: incidentId,
                status: status,
                admin_notes: adminNotes
            })
        });

        const result = await response.json();

        if (result.success) {
            showAlert('Incident status updated successfully', 'success');
            detailModal.style.display = 'none';
            loadIncidents();
        } else {
            showAlert('Error: ' + (result.error || 'Failed to update'), 'error');
        }
    } catch (error) {
        console.error('Update error:', error);
        showAlert('Error updating incident status', 'error');
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Delete Incident
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function deleteIncident(incidentId) {
    showConfirm('Delete this incident report?', async () => {
        try {
            const response = await fetch('api/delete_incident.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ incident_id: incidentId })
            });

            const result = await response.json();

            if (result.success) {
                showAlert('Incident deleted successfully', 'success');
                loadIncidents();
            } else {
                showAlert('Error: ' + (result.error || 'Failed to delete'), 'error');
            }
        } catch (error) {
            console.error('Delete error:', error);
            showAlert('Error deleting incident', 'error');
        }
    });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Initial Load
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Setup incidents table on first load (wait for completion)
async function initializePage() {
    try {
        await fetch('api/setup_incidents_table.php');
    } catch (e) {
        console.error('Setup warning (non-critical):', e);
    }
    
    // Load incidents (will return empty array if table doesn't exist yet)
    await loadIncidents();
}

initializePage();</script>
</body>
</html>