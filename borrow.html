<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SKalinga - Borrow Resources</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="assets/css/global.css">
  <link rel="stylesheet" href="assets/css/portal.css">
  <link rel="stylesheet" href="assets/css/borrow.css"> <!-- New CSS file for this page -->
</head>
<body>

<div class="app-container">

  <!-- Top Navigation – Centered with Logos on Both Sides -->
  <nav class="top-nav" style="padding: 24px 32px;">
    <div class="logo-area" style="display: flex; align-items: center; justify-content: center; gap: 24px; width: 100%;">
      <img src="assets/images/logosanantonio.jpg" alt="San Antonio Logo" class="official-logo" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 16px rgba(0,0,0,0.15);">
      <div class="logo-text" style="text-align: center;">
        <h1 style="font-size: 40px; font-weight: 800; color: var(--primary-green); margin: 0; line-height: 1;">SKalinga</h1>
        <p style="font-size: 16px; color: var(--text-gray); margin: 4px 0 0; font-weight: 500;">Youth Portal</p>
      </div>
      <img src="assets/images/sklogo.jpg" alt="SK Logo" class="official-logo" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 16px rgba(0,0,0,0.15);">
    </div>
  </nav>

  <!-- Back Button (Top-Left) -->
  <button class="back-btn" onclick="window.location.href='youth-portal.html'">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M19 12H5"></path>
      <path d="M12 19l-7-7 7-7"></path>
    </svg>
  </button>

  <!-- Page Header -->
  <header class="page-header">
    <h1>Borrow Resources</h1>
    <p>Request equipment and materials for your activities. Show your Digital Youth ID for quick admin scanning.</p>
  </header>

  <!-- Borrow Section -->
  <section class="borrow-section">
    <!-- Request New Borrow Button -->
    <div class="request-new">
      <button class="btn primary" id="requestBorrowBtn">Request New Borrow (Show ID for Scan)</button>
    </div>

    <!-- Recent Borrowings List -->
    <div class="borrow-history">
      <h2>Recent Borrowings</h2>
      <div class="borrow-list" id="borrowList">
        <p style="text-align: center; color: var(--text-gray); padding: 20px;">Loading your borrowing history...</p>
      </div>
    </div>
  </section>

  <!-- Digital Youth ID Modal (opens for scanning) -->
  <div class="modal" id="digitalIdModal">
    <div class="modal-content">
      <span class="close-modal" id="closeModal">&times;</span>
      <h2>Digital Youth ID – For Admin Scan</h2>
      <p>Present this to the admin for quick scanning and form filling.</p>
      <div class="id-card-preview">
        <div class="id-header">
          <img src="assets/images/sklogo.jpg" alt="SK Logo" class="id-logo" />
          <h3>SKalinga Youth</h3>
          <p>San Antonio Chapter</p>
        </div>
        <div class="id-body">
          <img src="assets/images/default-avatar.png" alt="Member Photo" class="id-photo" />
          <div class="id-info">
            <h4 id="userFullName">Loading...</h4>
            <p class="id-number">Member ID: <strong id="userMemberId">SK-XXXX-XXXX</strong></p>
            <p class="id-date">Issued: <span id="userIssuedDate">Loading...</span></p>
          </div>
        </div>
        <div class="qr-section">
          <img id="userQRCode" src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=SK-XXXX-XXXX" alt="QR Code" class="qr-code" />
          <p>Scan to verify and auto-fill borrower details</p>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  // Global variable to store current user's member ID
  let currentUser = {};

  // Fetch user profile and populate Digital Youth ID
  async function loadUserProfile() {
    try {
      const response = await fetch('api/get_user_profile.php?role=youth');
      const data = await response.json();
      
      if (data.success && data.user) {
        const user = data.user;
        currentUser = user; // Store for use in loadBorrowHistory()
        
        // Update modal with user data
        document.getElementById('userFullName').textContent = user.name;
        document.getElementById('userMemberId').textContent = user.member_id;
        document.getElementById('userIssuedDate').textContent = user.issued_date;
        
        // Generate dynamic QR code with member ID and user name
        const qrData = encodeURIComponent(user.member_id + '-' + user.name);
        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${qrData}`;
        document.getElementById('userQRCode').src = qrCodeUrl;
        
        // Load borrow history after profile is loaded
        loadBorrowHistory();
      } else {
        console.error('Failed to load user profile:', data.error);
        // Show error state
        document.getElementById('userFullName').textContent = 'Error loading profile';
        document.getElementById('userMemberId').textContent = 'Not Found';
        showNoBorrowHistory();
      }
    } catch (error) {
      console.error('Error loading user profile:', error);
      document.getElementById('userFullName').textContent = 'Error loading profile';
      document.getElementById('userMemberId').textContent = 'Not Found';
      showNoBorrowHistory();
    }
  }

  // Load borrow history from API
  async function loadBorrowHistory() {
    try {
      const response = await fetch('api/get_borrow_records.php');
      const data = await response.json();
      
      if (data.success && data.data && Array.isArray(data.data)) {
        // Filter records by current user's member_id
        const userRecords = data.data.filter(record => record.member_id === currentUser.member_id);
        
        // Sort by borrow_date descending (most recent first)
        userRecords.sort((a, b) => new Date(b.borrow_date) - new Date(a.borrow_date));
        
        if (userRecords.length > 0) {
          renderBorrowHistory(userRecords);
        } else {
          showNoBorrowHistory();
        }
      } else {
        showNoBorrowHistory();
      }
    } catch (error) {
      console.error('Error loading borrow history:', error);
      showNoBorrowHistory();
    }
  }

  // Render borrow history cards
  function renderBorrowHistory(records) {
    const borrowList = document.getElementById('borrowList');
    borrowList.innerHTML = '';
    
    records.forEach(record => {
      // Determine status
      let statusClass = 'borrowed';
      let statusText = 'Borrowed';
      
      if (record.status === 'Returned' || record.return_date) {
        statusClass = 'returned';
        statusText = 'Returned';
      } else if (record.due_date) {
        // Check if overdue
        const dueDate = new Date(record.due_date);
        const today = new Date();
        if (today > dueDate) {
          statusClass = 'overdue';
          statusText = 'Overdue';
        }
      }
      
      // Format dates
      const borrowDate = new Date(record.borrow_date);
      const borrowDateStr = borrowDate.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      const dueDate = new Date(record.due_date);
      const dueDateStr = dueDate.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
      
      const returnDateStr = record.return_date ? new Date(record.return_date).toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      }) : 'Not yet returned';
      
      // Create card HTML
      const card = document.createElement('div');
      card.className = 'borrow-item';
      card.innerHTML = `
        <div class="item-info">
          <h3>${record.item_name || 'Unknown Item'}</h3>
          <p><strong>Quantity:</strong> ${record.quantity || 1}</p>
          <p><strong>Borrowed:</strong> ${borrowDateStr}</p>
          <p><strong>Due:</strong> ${dueDateStr}</p>
          <p><strong>Returned:</strong> ${returnDateStr}</p>
          <span class="status ${statusClass}">${statusText}</span>
        </div>
      `;
      
      borrowList.appendChild(card);
    });
  }

  // Show message when no borrow history exists
  function showNoBorrowHistory() {
    const borrowList = document.getElementById('borrowList');
    borrowList.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 40px 20px;">No borrowing history yet. Request items using the "Request New Borrow" button above.</p>';
  }

  // Load user profile on page load
  document.addEventListener('DOMContentLoaded', loadUserProfile);

  // Open ID modal for new borrow request
  const requestBtn = document.getElementById('requestBorrowBtn');
  const modal = document.getElementById('digitalIdModal');
  const close = document.getElementById('closeModal');

  if (requestBtn && modal) {
    requestBtn.onclick = () => modal.style.display = 'flex';
    close.onclick = () => modal.style.display = 'none';
    window.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };
  }
</script>
</body>
</html>