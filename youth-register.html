<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SKalinga Youth â€¢ Register</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Shared + auth-specific styles -->
  <link rel="stylesheet" href="assets/css/global.css">
  <link rel="stylesheet" href="assets/css/auth.css">

  <!-- Supabase Client Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Session Checker Helper -->
  <script src="js/session-checker.js"></script>
</head>
<body>

<div class="container">

  <!-- Left side - Visual / Welcome area -->
  <div class="left-side">
    <div class="logos-row">
      <img src="assets/images/logosanantonio.jpg" alt="San Antonio Logo">
      <img src="assets/images/sklogo.jpg" alt="SK San Antonio">
    </div>

    <h2>Welcome to SKalinga Youth</h2>
    <p>Become part of the official youth platform of Barangay San Antonio and participate in community programs and initiatives.</p>

    <div class="image-grid">
      <img src="assets/images/print.jpg">
      <img src="assets/images/skoffice.jpg">
      <img src="assets/images/skexample.jpg">
      <img src="assets/images/zumba.jpg">
      <img src="assets/images/supplieskit.jpg">
      <img src="assets/images/groupphoto.jpg">
      <img src="assets/images/awardsk.jpg">
      <img src="assets/images/sammap.jpg">
    </div>
  </div>

  <!-- Right side - Registration Form -->
  <div class="right-side">

    <div class="header-logos">
      <img src="assets/images/noellogo.png" alt="Noel Logo">
      <img src="assets/images/moro.png" alt="MORO Movement">
    </div>

    <h1>Create Your Account</h1>
    <div class="subtitle">Join the SK youth movement today</div>

    <form action="api/register.php" method="post" id="registerForm">

      <div class="form-row">
    <div class="form-group half">
      <label for="firstname">First Name</label>
      <input type="text" id="firstname" name="firstname" placeholder="Juan" required>
    </div>
    <div class="form-group half">
      <label for="lastname">Last Name</label>
      <input type="text" id="lastname" name="lastname" placeholder="Dela Cruz" required>
    </div>
  </div>

      <!-- Birthday & Age side-by-side -->
      <div class="form-row">
        <div class="form-group half">
          <label for="birthday">Birthday</label>
          <input type="date" id="birthday" name="birthday" required>
        </div>
        <div class="form-group half">
          <label for="age">Age</label>
          <input type="number" id="age" name="age" min="13" max="35" placeholder="Auto-calculated" readonly required>
        </div>
      </div>

      <div class="form-row">
    <div class="form-group half">
      <label for="gender">Gender</label>
      <select id="gender" name="gender" required>
        <option value="" disabled selected>Select gender</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Other">Other</option>
        <option value="Prefer not to say">Prefer not to say</option>
      </select>
    </div>
    <div class="form-group half">
      <label for="email">Email Address</label>
      <input type="email" id="email" name="email" placeholder="juan@example.com" required>
    </div>
  </div>

  <!-- Full Address -->
  <label for="address">Full Address</label>
  <input type="text" id="address" name="address" placeholder="1111 Avocado St. Garcia Subd. Brgy. San Antonio, Binan, Laguna" required>

  <!-- Contact Number (no SMS verification needed) -->
  <div class="form-row">
    <div class="form-group half">
      <label for="contact">Contact Number</label>
      <input type="tel" id="contact" name="contact"
             placeholder="09123456789"
             pattern="[0-9]{11}"
             title="11-digit Philippine mobile number"
             required>
      <small id="contact-status" class="status-message"></small>
    </div>
  </div>
      
      <label for="password">Create Password</label>
      <input type="password" id="password" name="password" placeholder="At least 8 characters" minlength="8" required>

      <label for="confirm-password">Confirm Password</label>
      <input type="password" id="confirm-password" name="confirm-password" placeholder="Re-type password" required>
      <small id="password-warning" class="password-warning">
  âš  Passwords do not match
</small>


      <div class="privacy">
        <div class="checkbox-group">
          <input type="checkbox" id="privacy-consent" name="privacy-consent" required>
          <label for="privacy-consent" style="margin:0; cursor:pointer;">
            I agree to the <a href="#" target="_blank">Data Privacy Policy</a> and consent to the collection and processing of my personal information in accordance with RA 10173 (Data Privacy Act of 2012).
          </label>
        </div>
      </div>

      <button type="submit" class="btn" id="submitBtn" disabled>Create Account</button>

    </form>

    <div class="extra">
      Already have an account? <a href="index.html">Sign in here</a>
    </div>

  </div>

</div>

<script>
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Supabase Registration with Auth Integration
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const registerForm = document.getElementById('registerForm');
  const submitBtn = document.getElementById('submitBtn');
  const password = document.getElementById('password');
  const confirmPassword = document.getElementById('confirm-password');
  const privacy = document.getElementById('privacy-consent');
  const warning = document.getElementById('password-warning');

  // Auto-calculate age from birthday
  document.getElementById('birthday').addEventListener('change', function() {
    if (!this.value) {
      document.getElementById('age').value = '';
      checkFormValidity();
      return;
    }

    const birthDate = new Date(this.value);
    const today = new Date();

    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();

    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }

    if (age >= 0 && age <= 120) {
      document.getElementById('age').value = age;
    } else {
      document.getElementById('age').value = '';
      alert("Please enter a valid birthday.");
    }

    checkFormValidity();
  });

  // Real-time password match feedback
  function checkFormValidity() {
    const passwordsMatch = password.value === confirmPassword.value;
    const strongEnough = password.value.length >= 8;

    if (!passwordsMatch && confirmPassword.value.length > 0) {
      warning.style.display = "block";
      confirmPassword.classList.add("error");
    } else {
      warning.style.display = "none";
      confirmPassword.classList.remove("error");
    }

    submitBtn.disabled = !privacy.checked || !passwordsMatch || !strongEnough;
  }

  password.addEventListener('input', checkFormValidity);
  confirmPassword.addEventListener('input', checkFormValidity);
  privacy.addEventListener('change', checkFormValidity);

  // Form submission - Register with Supabase Auth
  registerForm.addEventListener('submit', async function(e) {
    e.preventDefault();

    // Collect form data
    const firstname = document.getElementById('firstname').value.trim();
    const lastname = document.getElementById('lastname').value.trim();
    const email = document.getElementById('email').value.trim();
    const birthday = document.getElementById('birthday').value;
    const age = document.getElementById('age').value;
    const gender = document.getElementById('gender').value;
    const contact = document.getElementById('contact').value.trim();
    const address = document.getElementById('address').value.trim();
    const pwd = password.value;

    // Extract barangay from address
    const addressMatch = address.match(/Brgy\.?\s*([^,]+)/i) || address.match(/Barangay\s*([^,]+)/i);
    const barangay = addressMatch ? addressMatch[1].trim() : '';

    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating Account...';

    try {
      // 1. Register with Supabase Auth
      const { data: authData, error: authError } = await supabaseClient.auth.signUp({
        email: email,
        password: pwd,
        options: {
          data: {
            firstname: firstname,
            lastname: lastname
          }
        }
      });

      if (authError) throw authError;
      if (!authData.user) throw new Error('Registration failed - no user returned');

      const userId = authData.user.id;

      // 2. Generate Member ID
      const timestamp = Date.now().toString().slice(-6);
      const random = Math.floor(Math.random() * 100).toString().padStart(2, '0');
      const memberId = `SK-${timestamp}${random}`;

      // 3. Create youth profile in database
      const { data: profileData, error: profileError } = await supabaseClient
        .from('youth_profiles')
        .insert([
          {
            user_id: userId,
            member_id: memberId,
            firstname: firstname,
            lastname: lastname,
            email: email,
            birthday: birthday,
            age: parseInt(age),
            gender: gender,
            contact: contact,
            address: address,
            barangay: barangay,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          }
        ]);

      if (profileError) throw profileError;

      // Success!
      alert(`ğŸ‰ Registration successful! Your Member ID is: ${memberId}\n\nPlease check your email to verify your account, then log in.`);

      // Clear form and redirect
      registerForm.reset();
      checkFormValidity();
      
      // Redirect to login page
      window.location.href = 'index.html';

    } catch (error) {
      console.error('Registration error:', error);
      
      let errorMessage = error.message || 'An unknown error occurred';
      
      // User-friendly error messages
      if (errorMessage.includes('already registered')) {
        errorMessage = 'This email is already registered. Please log in or use a different email.';
      } else if (errorMessage.includes('invalid_grant')) {
        errorMessage = 'Invalid credentials. Please check your password.';
      }
      
      alert(`âŒ Registration failed:\n\n${errorMessage}`);
      
      submitBtn.disabled = false;
      submitBtn.textContent = 'Create Account';
    }
  });
</script>

</body>
</html>