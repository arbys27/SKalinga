<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SKalinga Youth â€¢ Register</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Shared + auth-specific styles -->
  <link rel="stylesheet" href="assets/css/global.css">
  <link rel="stylesheet" href="assets/css/auth.css">

  <style>
    /* Toast Notification Styles */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      font-weight: 500;
      z-index: 9999;
      animation: slideIn 0.3s ease-out;
      max-width: 400px;
    }

    .toast.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .toast.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .toast.info {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .toast-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .toast-content {
      flex: 1;
    }

    .toast-close {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
      margin-left: 8px;
      opacity: 0.8;
      transition: opacity 0.2s;
    }

    .toast-close:hover {
      opacity: 1;
    }

    @keyframes slideIn {
      from {
        transform: translateX(420px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(420px);
        opacity: 0;
      }
    }

    .toast.removing {
      animation: slideOut 0.3s ease-out forwards;
    }

    @media (max-width: 640px) {
      .toast {
        bottom: 20px;
        right: 20px;
        left: 20px;
        max-width: none;
      }
    }
  </style>
</head>
<body>

<div class="container">

  <!-- Left side - Visual / Welcome area -->
  <div class="left-side">
    <div class="logos-row">
      <img src="assets/images/logosanantonio.jpg" alt="San Antonio Logo">
      <img src="assets/images/sklogo.jpg" alt="SK San Antonio">
    </div>

    <h2>Welcome to SKalinga Youth</h2>
    <p>Become part of the official youth platform of Barangay San Antonio and participate in community programs and initiatives.</p>

    <div class="image-grid">
      <img src="assets/images/print.jpg">
      <img src="assets/images/skoffice.jpg">
      <img src="assets/images/skexample.jpg">
      <img src="assets/images/zumba.jpg">
      <img src="assets/images/supplieskit.jpg">
      <img src="assets/images/groupphoto.jpg">
      <img src="assets/images/awardsk.jpg">
      <img src="assets/images/sammap.jpg">
    </div>
  </div>

  <!-- Right side - Registration Form -->
  <div class="right-side">

    <div class="header-logos">
      <img src="assets/images/noellogo.png" alt="Noel Logo">
      <img src="assets/images/moro.png" alt="MORO Movement">
    </div>

    <h1>Create Your Account</h1>
    <div class="subtitle">Join the SK youth movement today</div>

    <form action="api/register.php" method="post" id="registerForm">

      <div class="form-row">
    <div class="form-group half">
      <label for="firstname">First Name</label>
      <input type="text" id="firstname" name="firstname" placeholder="Juan" required>
    </div>
    <div class="form-group half">
      <label for="lastname">Last Name</label>
      <input type="text" id="lastname" name="lastname" placeholder="Dela Cruz" required>
    </div>
  </div>

      <!-- Birthday & Age side-by-side -->
      <div class="form-row">
        <div class="form-group half">
          <label for="birthday">Birthday</label>
          <input type="date" id="birthday" name="birthday" required>
        </div>
        <div class="form-group half">
          <label for="age">Age</label>
          <input type="number" id="age" name="age" placeholder="Auto-calculated" readonly required>
        </div>
      </div>

      <div class="form-row">
    <div class="form-group half">
      <label for="gender">Gender</label>
      <select id="gender" name="gender" required>
        <option value="" disabled selected>Select gender</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Other">Other</option>
        <option value="Prefer not to say">Prefer not to say</option>
      </select>
    </div>
    <div class="form-group half">
      <label for="email">Email Address</label>
      <input type="email" id="email" name="email" placeholder="juan@example.com" required>
    </div>
  </div>

  <!-- Full Address -->
  <label for="address">Full Address</label>
  <input type="text" id="address" name="address" placeholder="1111 Avocado St. Garcia Subd. Brgy. San Antonio, Binan, Laguna" required>

  <!-- Contact Number with Verify Button -->
  <div class="form-row">
    <div class="form-group half">
      <label for="contact">Contact Number</label>
      <div class="contact-input-group">
        <input type="tel" id="contact" name="contact"
               placeholder="09123456789"
               pattern="[0-9]{11}"
               title="11-digit Philippine mobile number"
               required>
        <button type="button" id="verifyBtn" class="btn-icon-verify" disabled title="Verify Phone Number" aria-label="Verify phone number">Verify</button>
      </div>
      <small id="contact-status" class="status-message"></small>
    </div>
  </div>

  <!-- OTP Verification Field (initially hidden) -->
  <div id="otp-section">
    <div class="form-row">
      <div class="form-group half">
        <label for="otp">Enter OTP</label>
        <div class="contact-input-group">
          <input type="text" id="otp" name="otp" placeholder="000000" maxlength="6" pattern="[0-9]{6}">
          <button type="button" id="verifyOtpBtn" class="btn-icon-verify" title="Verify OTP" aria-label="Verify one-time password">Verify</button>
        </div>
        <small id="otp-status" class="status-message"></small>
      </div>
    </div>
  </div>
  
  <!-- Hidden field to track verification status -->
  <input type="hidden" id="phone-verified" name="phone-verified" value="0">
      
      <label for="password">Create Password</label>
      <input type="password" id="password" name="password" placeholder="At least 8 characters" minlength="8" required>

      <label for="confirm-password">Confirm Password</label>
      <input type="password" id="confirm-password" name="confirm-password" placeholder="Re-type password" required>
      <small id="password-warning" class="password-warning">
  âš  Passwords do not match
</small>


      <div class="privacy">
        <div class="checkbox-group">
          <input type="checkbox" id="privacy-consent" name="privacy-consent" required>
          <label for="privacy-consent" style="margin:0; cursor:pointer;">
            I agree to the <a href="#" target="_blank">Data Privacy Policy</a> and consent to the collection and processing of my personal information in accordance with RA 10173 (Data Privacy Act of 2012).
          </label>
        </div>
      </div>

      <button type="submit" class="btn" id="submitBtn" disabled>Create Account</button>

    </form>

    <div class="extra">
      Already have an account? <a href="index.html">Sign in here</a>
    </div>

  </div>

</div>

<script>
  // Toast Notification Function
  function showToast(message, type = 'success', duration = 3000) {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icons = {
      success: 'âœ“',
      error: 'âœ—',
      info: 'â„¹'
    };
    
    toast.innerHTML = `
      <span class="toast-icon">${icons[type]}</span>
      <span class="toast-content">${message}</span>
      <button class="toast-close">Ã—</button>
    `;
    
    toastContainer.appendChild(toast);
    
    const closeBtn = toast.querySelector('.toast-close');
    closeBtn.addEventListener('click', () => removeToast(toast));
    
    if (duration > 0) {
      setTimeout(() => removeToast(toast), duration);
    }
    
    return toast;
  }

  function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    document.body.appendChild(container);
    return container;
  }

  function removeToast(toast) {
    toast.classList.add('removing');
    setTimeout(() => {
      if (toast.parentElement) {
        toast.remove();
      }
    }, 300);
  }

  // SMS OTP Verification
  const contact = document.getElementById('contact');
  const verifyBtn = document.getElementById('verifyBtn');
  const verifyOtpBtn = document.getElementById('verifyOtpBtn');
  const otpSection = document.getElementById('otp-section');
  const otpInput = document.getElementById('otp');
  const contactStatus = document.getElementById('contact-status');
  const otpStatus = document.getElementById('otp-status');
  const phoneVerified = document.getElementById('phone-verified');
  
  let otpTimerInterval = null;
  let otpCountdown = 0;

  // Hide OTP section by default
  otpSection.style.display = 'none';

  // Enable verify button only when valid phone number is entered
  contact.addEventListener('input', function() {
    const isValidPhone = this.value.length === 11 && /^[0-9]{11}$/.test(this.value);
    verifyBtn.disabled = !isValidPhone || otpCountdown > 0;
    
    // Reset OTP section if phone number changes
    if (phoneVerified.value === '1') {
      resetOtpVerification();
    }
  });

  // Start OTP countdown timer
  function startOtpTimer() {
    // Clear any existing timer
    if (otpTimerInterval) {
      clearInterval(otpTimerInterval);
    }
    
    otpCountdown = 60;
    verifyBtn.disabled = true;
    verifyBtn.textContent = `Resend OTP (${otpCountdown}s)`;
    
    otpTimerInterval = setInterval(function() {
      otpCountdown--;
      verifyBtn.textContent = `Resend OTP (${otpCountdown}s)`;
      
      if (otpCountdown <= 0) {
        clearInterval(otpTimerInterval);
        otpTimerInterval = null;
        otpCountdown = 0;
        verifyBtn.disabled = false;
        verifyBtn.textContent = 'Resend OTP';
      }
    }, 1000);
  }

  // Handle Verify button click - send SMS OTP
  verifyBtn.addEventListener('click', function(e) {
    e.preventDefault();
    
    const phoneNumber = contact.value;
    
    if (!phoneNumber || phoneNumber.length !== 11) {
      alert('Please enter a valid 11-digit phone number');
      return;
    }

    verifyBtn.disabled = true;
    verifyBtn.textContent = 'Sending...';
    contactStatus.textContent = '';
    contactStatus.className = 'status-message';

    // Send request to backend to send SMS OTP
    fetch('api/send_registration_otp.php', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: 'phone=' + encodeURIComponent(phoneNumber)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        contactStatus.textContent = 'âœ“ OTP sent to your number. Enter it below.';
        contactStatus.className = 'status-message success';
        showToast('OTP sent successfully to your phone', 'success', 3000);
        otpSection.style.display = 'block';
        startOtpTimer();
        otpInput.focus();
      } else {
        contactStatus.textContent = 'âœ— Failed to send OTP: ' + data.message;
        contactStatus.className = 'status-message error';
        showToast('Failed to send OTP: ' + data.message, 'error', 4000);
        verifyBtn.disabled = false;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      contactStatus.textContent = 'âœ— Error sending OTP. Please try again.';
      contactStatus.className = 'status-message error';
      showToast('Error sending OTP. Please try again.', 'error', 4000);
      // Keep button disabled during timer, otherwise enable it
      if (otpCountdown <= 0) {
        verifyBtn.disabled = false;
      }
    });
  });

  // Handle Verify OTP button click
  verifyOtpBtn.addEventListener('click', function(e) {
    e.preventDefault();
    
    const otp = otpInput.value.trim();
    const phoneNumber = contact.value;

    if (!otp || otp.length !== 6 || !/^[0-9]{6}$/.test(otp)) {
      alert('Please enter a valid 6-digit OTP');
      return;
    }

    verifyOtpBtn.disabled = true;
    verifyOtpBtn.textContent = 'Verifying...';
    otpStatus.textContent = '';
    otpStatus.className = 'status-message';

    // Verify OTP with backend
    fetch('api/verify_registration_otp.php', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: 'otp=' + encodeURIComponent(otp)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        phoneVerified.value = '1';
        contactStatus.textContent = 'âœ“ Phone number verified';
        contactStatus.className = 'status-message success';
        otpStatus.textContent = 'âœ“ Phone verified successfully';
        otpStatus.className = 'status-message success';
        verifyOtpBtn.disabled = true;
        contact.readOnly = true;  // âœ… Use readOnly instead of disabled
        verifyBtn.disabled = true;
        showToast('Phone verified successfully! âœ“', 'success', 3000);
        // Clear timer when verified
        if (otpTimerInterval) {
          clearInterval(otpTimerInterval);
          otpTimerInterval = null;
        }
        otpCountdown = 0;
        checkFormValidity();
      } else {
        otpStatus.textContent = 'âœ— Invalid OTP. Please try again.';
        otpStatus.className = 'status-message error';
        showToast('Invalid OTP. Please try again.', 'error', 3000);
        verifyOtpBtn.disabled = false;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      otpStatus.textContent = 'âœ— Error verifying OTP. Please try again.';
      otpStatus.className = 'status-message error';
      showToast('Error verifying OTP. Please try again.', 'error', 3000);
      verifyOtpBtn.disabled = false;
    });
  });

  // Reset OTP verification
  function resetOtpVerification() {
    // Clear timer if running
    if (otpTimerInterval) {
      clearInterval(otpTimerInterval);
      otpTimerInterval = null;
    }
    otpCountdown = 0;
    
    phoneVerified.value = '0';
    otpSection.style.display = 'none';
    otpInput.value = '';
    otpStatus.textContent = '';
    otpStatus.className = 'status-message';
    contactStatus.textContent = '';
    contactStatus.className = 'status-message';
    contact.readOnly = false;  // âœ… Make it editable again
    verifyBtn.disabled = false;
    verifyBtn.textContent = 'Verify';
  }

  // Enable submit only when privacy is checked AND passwords match AND phone is verified
  const privacy = document.getElementById('privacy-consent');
  const submitBtn = document.getElementById('submitBtn');
  const password = document.getElementById('password');
  const confirmPassword = document.getElementById('confirm-password');
  const registerForm = document.getElementById('registerForm');

  function checkFormValidity() {
    const passwordsMatch = password.value === confirmPassword.value && password.value.length >= 8;
    const phoneIsVerified = phoneVerified.value === '1';
    submitBtn.disabled = !privacy.checked || !passwordsMatch || !phoneIsVerified;
  }

  privacy.addEventListener('change', checkFormValidity);
  password.addEventListener('input', checkFormValidity);
  confirmPassword.addEventListener('input', checkFormValidity);

  // Auto-calculate age from birthday (improved version)
  document.getElementById('birthday').addEventListener('change', function() {
    if (!this.value) {
      document.getElementById('age').value = '';
      checkFormValidity();
      return;
    }

    const birthDate = new Date(this.value);
    const today = new Date();

    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();

    // Adjust age if birthday hasn't occurred this year yet
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }

    // Allow realistic ages: 0-120 years old (prevents negative ages and impossible ages like 200+)
    if (age >= 0 && age <= 120) {
      document.getElementById('age').value = age;
    } else {
      document.getElementById('age').value = '';
      if (age < 0) {
        alert("âŒ Birthday cannot be in the future.");
      } else {
        alert("âŒ Please enter a realistic birthday (max 120 years old).");
      }
    }

    checkFormValidity();
  });

  // Real-time password match feedback
  const warning = document.getElementById('password-warning');

  function checkFormValidity() {
    const passwordsMatch = password.value === confirmPassword.value;
    const strongEnough = password.value.length >= 8;

    if (!passwordsMatch && confirmPassword.value.length > 0) {
      warning.style.display = "block";
      confirmPassword.classList.add("error");
    } else {
      warning.style.display = "none";
      confirmPassword.classList.remove("error");
    }

    submitBtn.disabled = !privacy.checked || !passwordsMatch || !strongEnough;
  }

  password.addEventListener('input', checkFormValidity);
  confirmPassword.addEventListener('input', checkFormValidity);
  privacy.addEventListener('change', checkFormValidity);

  // Handle form submission with AJAX
  registerForm.addEventListener('submit', function(e) {
    e.preventDefault();

    // Disable submit button to prevent double submission
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating Account...';

    // Create FormData object
    const formData = new FormData(this);

    // Send AJAX request
    fetch('api/register.php', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Registration successful - show toast
        showToast(`ðŸŽ‰ Registration successful! Your Member ID is: ${data.member_id}`, 'success', 4000);

        // Redirect to login page after a short delay
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
      } else {
        // Registration failed - show error toast
        let errorMessage = data.message;
        if (data.errors && data.errors.length > 0) {
          errorMessage += ' - ' + data.errors.join(', ');
        }
        showToast(errorMessage, 'error', 5000);

        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Account';
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast('An error occurred. Please try again.', 'error', 5000);

      // Re-enable submit button
      submitBtn.disabled = false;
      submitBtn.textContent = 'Create Account';
    });
  });
</script>

</body>
</html>