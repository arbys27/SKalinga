<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SKalinga - Print Services</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="assets/css/global.css">
  <link rel="stylesheet" href="assets/css/portal.css">
  <link rel="stylesheet" href="assets/css/print.css">
</head>
<body>

<div class="app-container">

  <!-- Top Navigation -->
  <nav class="top-nav" style="padding: 24px 32px;">
    <div class="logo-area" style="display: flex; align-items: center; justify-content: center; gap: 24px; width: 100%;">
      <img src="assets/images/logosanantonio.jpg" alt="San Antonio Logo" class="official-logo" style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 16px rgba(0,0,0,0.15);">
      <div class="logo-text" style="text-align: center;">
        <h1 style="font-size: 36px; font-weight: 800; color: var(--primary-green); margin: 0; line-height: 1;">SKalinga</h1>
        <p style="font-size: 15px; color: var(--text-gray); margin: 4px 0 0; font-weight: 500;">Youth Portal</p>
      </div>
      <img src="assets/images/sklogo.jpg" alt="SK Logo" class="official-logo" style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 16px rgba(0,0,0,0.15);">
    </div>
  </nav>

  <!-- Back Button -->
  <button class="back-btn" onclick="window.location.href='youth-portal.html'">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <path d="M19 12H5M12 19l-7-7 7-7"></path>
    </svg>
  </button>

  <!-- Page Header -->
  <header class="page-header">
    <h1>Print Services</h1>
    <p>Upload your documents and request printing at SK Office. After submission, present your Digital Youth ID for confirmation.</p>
  </header>

  <!-- Print Section -->
  <section class="print-section">
    <!-- Request New Print -->
    <div class="request-new">
      <button class="btn primary large" id="requestPrintBtn">Request New Print</button>
    </div>

    <!-- Upload Form -->
    <div id="uploadSection" style="display:none; margin-top: 40px;">
      <h2>Upload Document for Printing</h2>
      <form id="printForm" class="print-form">
        <div class="form-group">
          <label for="documentTitle">Document Title *</label>
          <input type="text" id="documentTitle" name="document_title" placeholder="e.g., My Resume, Project Report" required>
        </div>

        <div class="form-group">
          <label for="document">Select File to Print *</label>
          <input type="file" id="document" name="document" accept=".pdf,.doc,.docx,.jpg,.png,.txt" required>
          <small>Allowed: PDF, Word, JPG, PNG, TXT • Max 10MB</small>
        </div>

        <!-- Print Type + Paper Size + Copies -->
        <div class="form-row">
          <div class="form-group half">
            <label for="printType">Print Type *</label>
            <select id="printType" name="print_type" required>
              <option value="" disabled selected>Select type</option>
              <option value="Black & White">Black & White</option>
              <option value="Colored">Colored</option>
            </select>
          </div>
          <div class="form-group half">
            <label for="paperSize">Paper Size *</label>
            <select id="paperSize" name="paper_size" required>
              <option value="" disabled selected>Select size</option>
              <option value="A4">A4</option>
              <option value="Short">Short Bond</option>
              <option value="Long">Long Bond</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="copies">Number of Copies *</label>
          <input type="number" id="copies" name="copies" min="1" max="100" placeholder="e.g., 5" value="1" required>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn primary large" id="submitPrintBtn">Send Document for Printing</button>
        </div>
      </form>
    </div>

    <!-- Print History -->
    <div class="print-history">
      <h2>Recent Print Requests</h2>
      <div class="print-list" id="printList">
        <!-- Items will be added dynamically -->
      </div>
    </div>
  </section>

  <!-- Digital Youth ID Modal (for confirmation after submission) -->
  <div class="modal" id="digitalIdModal">
    <div class="modal-content">
      <span class="close-modal" id="closeModal">&times;</span>
      <h2>Digital Youth ID – For Printing Verification</h2>
      <p>Present this to the SK Office for printing verification and payment reference.</p>
      <div class="id-card-preview">
        <div class="id-header">
          <img src="assets/images/sklogo.jpg" alt="SK Logo" class="id-logo" />
          <h3>SKalinga Youth</h3>
          <p>San Antonio Chapter</p>
        </div>
        <div class="id-body">
          <img src="assets/images/default-avatar.png" alt="Member Photo" class="id-photo" />
          <div class="id-info">
            <h4 id="userFullName">Loading...</h4>
            <p class="id-number">Member ID: <strong id="userMemberId">SK-XXXX-XXXX</strong></p>
            <p class="id-date">Issued: <span id="userIssuedDate">Loading...</span></p>
            <p class="id-request" style="color: #228B57; font-weight: 600; margin-top: 8px;">Request ID: <strong id="requestId">---</strong></p>
          </div>
        </div>
        <div class="qr-section">
          <img id="userQRCode" src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=SK-XXXX-XXXX" alt="QR Code" class="qr-code" />
          <p>Scan to verify and complete printing transaction</p>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  // Global variables
  let currentUser = {};

  // --- Upload Flow ---
  const requestBtn = document.getElementById('requestPrintBtn');
  const uploadSection = document.getElementById('uploadSection');
  const modal = document.getElementById('digitalIdModal');
  const closeModal = document.getElementById('closeModal');
  const printForm = document.getElementById('printForm');

  // Load user profile on page load
  document.addEventListener('DOMContentLoaded', loadUserProfile);

  // Load user profile for Digital Youth ID
  async function loadUserProfile() {
    try {
      const response = await fetch('api/get_user_profile.php?role=youth');
      const data = await response.json();
      
      if (data.success && data.user) {
        currentUser = data.user;
        // Don't populate ID yet - only show it after successful submission
      } else {
        console.error('Failed to load user profile:', data.error);
      }
    } catch (error) {
      console.error('Error loading user profile:', error);
    }
  }

  // Open upload section
  requestBtn.onclick = () => {
    uploadSection.style.display = 'block';
    window.scrollTo({ top: uploadSection.offsetTop - 100, behavior: 'smooth' });
  };

  // Close Digital ID modal
  closeModal.onclick = () => modal.style.display = 'none';
  window.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };

  // --- Form Submission with File Upload ---
  printForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const fileInput = document.getElementById('document');
    const file = fileInput.files[0];

    if (!file) {
      alert('Please select a file to print.');
      return;
    }

    // Validate file
    const allowedTypes = ['application/pdf', 'application/msword', 
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 
      'image/jpeg', 'image/png', 'text/plain'];
    const maxSize = 10 * 1024 * 1024;

    if (!allowedTypes.includes(file.type)) {
      alert('Only PDF, Word, JPG, PNG, TXT files are allowed.');
      return;
    }

    if (file.size > maxSize) {
      alert('File size exceeds 10MB limit.');
      return;
    }

    // Disable submit button during upload
    const submitBtn = document.getElementById('submitPrintBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Uploading...';

    try {
      // Prepare form data for multipart upload
      const formData = new FormData();
      formData.append('document', file);
      formData.append('document_title', document.getElementById('documentTitle').value);
      formData.append('print_type', document.getElementById('printType').value);
      formData.append('paper_size', document.getElementById('paperSize').value);
      formData.append('copies', document.getElementById('copies').value);

      // Send to API
      const response = await fetch('api/upload_print_request.php', {
        method: 'POST',
        credentials: 'include',
        body: formData
      });

      const result = await response.json();

      if (result.success) {
        // Store request ID for QR code
        const requestId = result.request_id;
        
        // Populate Digital Youth ID modal
        document.getElementById('userFullName').textContent = currentUser.name || 'Loading...';
        document.getElementById('userMemberId').textContent = currentUser.member_id || 'SK-XXXX-XXXX';
        document.getElementById('userIssuedDate').textContent = currentUser.issued_date || 'Loading...';
        document.getElementById('requestId').textContent = 'REQ-' + requestId.toString().padStart(4, '0');

        // Generate QR code with request ID
        const qrData = encodeURIComponent('SK-PRINT-' + currentUser.member_id + '-REQ' + requestId);
        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${qrData}`;
        document.getElementById('userQRCode').src = qrCodeUrl;

        // Reset form
        printForm.reset();
        uploadSection.style.display = 'none';

        // Show Digital Youth ID modal
        modal.style.display = 'flex';

        // Show success message
        setTimeout(() => {
          alert(`✅ Document "${result.data.document_title}" uploaded successfully!\n\nPresent your Digital Youth ID to the SK Office for verification.`);
        }, 500);

      } else {
        alert('❌ Error: ' + (result.error || 'Failed to upload document'));
      }
    } catch (error) {
      console.error('Upload error:', error);
      alert('Error uploading file. Please try again.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Send Document for Printing';
    }
  });

  // --- Print History ---
  async function loadPrintHistory() {
    try {
      const response = await fetch('api/get_user_print_requests.php', {
        credentials: 'include'
      });

      const data = await response.json();

      if (data.success) {
        renderPrintHistory(data.data);
      }
    } catch (error) {
      console.error('Error loading print history:', error);
    }
  }

  function renderPrintHistory(requests) {
    const list = document.getElementById('printList');
    list.innerHTML = '';

    if (requests.length === 0) {
      list.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 20px;">No print requests yet. Submit your first document above.</p>';
      return;
    }

    requests.forEach(item => {
      const dateTime = new Date(item.created_at).toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      const statusClass = item.status.toLowerCase().replace(' ', '-');
      
      const div = document.createElement('div');
      div.className = 'print-item';
      div.innerHTML = `
        <div class="item-info">
          <h3>${item.document_title}</h3>
          <p><strong>Submitted:</strong> ${dateTime}</p>
          <p><strong>Print Type:</strong> ${item.print_type}</p>
          <p><strong>Paper Size:</strong> ${item.paper_size}</p>
          <p><strong>Copies:</strong> ${item.copies}</p>
          <span class="status ${statusClass}">${item.status}</span>
        </div>
      `;
      list.appendChild(div);
    });
  }

  // Load print history on page load
  document.addEventListener('DOMContentLoaded', loadPrintHistory);
</script>
</body>
</html>